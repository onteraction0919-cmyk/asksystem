<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>질문 등록</title>
  <style>
    :root{
      --bg:#0e1320; --card:#12182b; --ink:#eaf0ff; --muted:#95a0c7;
      --brand:#6655ff; --brand-ink:#fff; --ring:rgba(102,85,255,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Pretendard,Apple Color Emoji,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:960px;margin:60px auto;padding:0 20px}
    h1{font-size:28px;margin:0 0 16px}
    .card{background:var(--card);border-radius:16px;padding:22px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    textarea{
      width:100%;min-height:180px;background:#0b1020;border:1px solid #1f2942;color:var(--ink);
      border-radius:12px;padding:16px;font-size:18px;line-height:1.6;outline:none;
    }
    textarea:focus{border-color:var(--brand);box-shadow:0 0 0 6px var(--ring)}
    .row{display:flex;gap:12px;align-items:center;margin-top:14px}
    .btn{
      background:var(--brand);color:var(--brand-ink);border:0;padding:10px 18px;border-radius:12px;
      font-weight:700;cursor:pointer;
    }
    .muted{color:var(--muted);font-size:14px}
    .list{margin-top:28px;display:grid;gap:12px}
    .item{background:#0b1020;border:1px solid #1f2942;border-radius:12px;padding:14px 14px;display:flex;gap:10px;align-items:flex-start}
    .item .txt{flex:1;white-space:pre-wrap;line-height:1.5}
    .item .small{color:#8ea1c0;font-size:12px;margin-top:6px}
    .xbtn{background:#2b3350;color:#c8d0f8;border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>질문 등록</h1>
    <div class="card">
      <textarea id="t" placeholder="질문을 입력하고 ‘등록’을 누르세요."></textarea>
      <div class="row">
        <button id="add" class="btn">등록</button>
        <div class="muted">사회자: <b>/mod</b> · 방송화면: <b>/spotlight</b></div>
      </div>
    </div>

    <div class="list" id="mine"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const elT = document.getElementById('t');
    const elAdd = document.getElementById('add');
    const elMine = document.getElementById('mine');
    const ioClient = io();

    // 서버 전체 목록에서 "내가 방금 보낸 것"만 간단히 보여주기 위한 메모
    const myIds = new Set();

    function fmt(ts){
      const d = new Date(ts);
      const z=(n)=>String(n).padStart(2,'0');
      return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
    }

    function renderMine(list){
      // 내가 등록한 것만
      const mine = list.filter(q => myIds.has(q.id));
      elMine.innerHTML = mine.map(q => `
        <div class="item">
          <div class="txt">
            <div>${q.text.replace(/&/g,"&amp;").replace(/</g,"&lt;")}</div>
            <div class="small">${fmt(q.createdAt)}</div>
          </div>
          <button class="xbtn" onclick="del('${q.id}')">삭제</button>
        </div>
      `).join('') || '';
    }

    async function add(){
      const text = elT.value.trim();
      if(!text) return;
      const r = await fetch('/api/questions', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ text })
      }).then(r=>r.json());
      if(r.ok){
        myIds.add(r.data.id);
        elT.value='';
      } else {
        alert(r.message || '등록 실패');
      }
    }

    async function del(id){
      if(!confirm('삭제할까요?')) return;
      const r = await fetch(`/api/questions/${id}`, { method:'DELETE' }).then(r=>r.json());
      if(!r.ok) alert('삭제 실패');
      else myIds.delete(id);
    }

    elAdd.addEventListener('click', add);
    elT.addEventListener('keydown', e => {
      if((e.metaKey||e.ctrlKey) && e.key==='Enter') add();
    });

    ioClient.on('questions:update', renderMine);
  </script>
</body>
</html>
