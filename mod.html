<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>사회자 질문 선택</title>
<style>
  :root{
    --bg:#0f1020;
    --panel:#111223;
    --card:#17192d;
    --text:#eef2ff;
    --muted:#a3aed0;
    --accent:#7c5cff;
    --accent-2:#5ad0ff;
    --ok:#20c997;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo","Noto Sans KR", sans-serif;
  }
  header{
    position:sticky; top:0; z-index:5;
    backdrop-filter:saturate(140%) blur(8px);
    background:linear-gradient(90deg, rgba(10,10,24,.75), rgba(10,10,24,.35));
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .bar{
    max-width:1200px; margin:0 auto; padding:14px 18px;
    display:flex; align-items:center; gap:16px; justify-content:space-between;
  }
  .brand{display:flex; align-items:center; gap:10px}
  .brand img{height:26px; width:auto; object-fit:contain}
  .brand .title{font-weight:800; letter-spacing:.2px}
  .sub{color:var(--muted); font-size:13px}

  .wrap{max-width:1200px; margin:22px auto; padding:0 18px}
  .controls{
    display:flex; gap:10px; align-items:center; margin-bottom:14px; flex-wrap:wrap;
  }
  .pill{
    border:1px solid rgba(255,255,255,.12); color:var(--muted);
    background:#0f1125; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:700;
  }
  .pill.active{color:#0b0c14; background:linear-gradient(135deg,var(--accent),var(--accent-2)); border-color:transparent}
  .hint{color:var(--muted); font-size:13px; margin-left:auto}

  .grid{
    display:grid; gap:16px;
    grid-template-columns:repeat(auto-fit, minmax(340px, 1fr));
  }

  .card{
    position:relative;
    background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.09);
    border-radius:18px;
    padding:16px 16px 14px 16px;
    box-shadow:0 10px 26px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.05);
    min-height:210px;
    display:flex; flex-direction:column; gap:12px;
  }
  .card.selected{
    border-color:rgba(124,92,255,.9);
    box-shadow:0 0 0 3px rgba(124,92,255,.25), 0 18px 36px rgba(92,64,250,.35);
  }

  .q{
    flex:1; overflow:auto; padding-right:4px;
    color:var(--text); font-size:20px; line-height:1.65; letter-spacing:.1px;
    word-break:keep-all; white-space:pre-wrap;
  }

  .meta{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .time{color:var(--muted); font-size:13px}
  .btn{
    position:absolute; right:12px; top:12px;
    border:none; cursor:pointer; padding:9px 12px; border-radius:12px;
    font-weight:800; color:#0b0c14;
    background:linear-gradient(135deg, var(--accent), var(--accent-2));
    box-shadow:0 10px 24px rgba(92,64,250,.35);
    transition:.15s transform;
  }
  .btn:active{transform:translateY(1px)}
  .badge{
    font-size:11px; color:#0b0c14; background:linear-gradient(135deg,#1cffb6,#31d2ff);
    border-radius:999px; padding:6px 10px; font-weight:900;
  }

  .empty{
    color:var(--muted); text-align:center; padding:60px 0 80px;
  }
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">
      <!-- 로고가 있으면 노출됨 -->
      <img src="/static/logo.png" alt="" onerror="this.style.display='none'">
      <div class="title">사회자 질문 선택</div>
    </div>
    <div class="sub">가장 좋은 질문을 골라 <span class="badge">방송 표시</span> 해주세요</div>
  </div>
</header>

<div class="wrap">
  <div class="controls">
    <button class="pill active" data-filter="all">전체</button>
    <button class="pill" data-filter="pending">대기</button>
    <button class="pill" data-filter="selected">선택됨</button>
    <div class="hint">2초마다 자동 갱신됩니다</div>
  </div>

  <div id="grid" class="grid"></div>
  <div id="empty" class="empty" style="display:none">들어온 질문이 없습니다.</div>
</div>

<script>
  const grid  = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const pills = [...document.querySelectorAll('.pill')];
  let filter  = 'all';
  let latest  = [];

  pills.forEach(p=>{
    p.addEventListener('click',()=>{
      pills.forEach(x=>x.classList.remove('active'));
      p.classList.add('active');
      filter = p.dataset.filter;
      render(latest);
    });
  });

  function fmtTime(ts){
    try{
      const d = new Date(ts);
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      const ss = String(d.getSeconds()).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }catch(e){ return '' }
  }

  function cardTemplate(q){
    const sel = q.selected ? ' selected' : '';
    return `
      <article class="card${sel}" data-id="${q.id}">
        <button class="btn" onclick="activate('${q.id}')">방송 표시</button>
        <div class="q">${escapeHtml(q.text)}</div>
        <div class="meta">
          <div class="time">${fmtTime(q.ts || q.time || q.createdAt)}</div>
          ${q.selected ? '<div class="badge">선택됨</div>' : ''}
        </div>
      </article>
    `;
  }

  function escapeHtml(s){
    return String(s||'')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function render(list){
    // 필터
    let data = [...list];
    if(filter==='pending') data = data.filter(x=>!x.selected);
    if(filter==='selected') data = data.filter(x=>x.selected);

    if(!data.length){
      grid.innerHTML = '';
      empty.style.display='block';
      return;
    }
    empty.style.display='none';
    // 최신순 정렬
    data.sort((a,b)=> (b.ts||b.time||0) - (a.ts||a.time||0));
    grid.innerHTML = data.map(cardTemplate).join('');
  }

  // 서버에서 질문 목록 가져오기
  async function fetchQuestions(){
    try{
      const r = await fetch('/api/questions'); // 기존 서버 라우트 그대로 사용
      if(!r.ok) throw 0;
      const arr = await r.json();
      latest = Array.isArray(arr) ? arr : (arr.items || []);
      render(latest);
    }catch(e){
      // 네트워크 오류 시 무시(다음 틱에 재시도)
    }
  }

  // 방송 활성화 호출
  async function activate(id){
    try{
      const r = await fetch('/spotlight/active', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ id })
      });
      // 성공 시 해당 카드에 selected 표시
      latest = latest.map(x => x.id===id ? ({...x, selected:true}) : x);
      render(latest);
    }catch(e){
      alert('네트워크 오류로 실패했습니다. 다시 시도해주세요.');
    }
  }

  // 2초마다 갱신
  fetchQuestions();
  setInterval(fetchQuestions, 2000);
</script>
</body>
</html>
