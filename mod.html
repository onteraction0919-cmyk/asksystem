<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>사회자 질문 선택</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0d1117;--card:#111826;--txt:#e6e8ee;--accent:#7c7cff;--muted:#9aa4b2}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:Pretendard,system-ui,Apple SD Gothic Neo,sans-serif}
  header{display:flex;justify-content:space-between;align-items:center;padding:24px 3vw}
  h1{margin:0;font-size:24px}
  .btn{background:var(--accent);color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
  .grid{display:grid;gap:18px;padding:0 3vw 40px;grid-template-columns:repeat(auto-fit,minmax(360px,1fr))}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:18px;display:flex;flex-direction:column;gap:14px}
  .txt{white-space:pre-wrap;word-break:keep-all;line-height:1.55;font-size:20px}
  .meta{color:var(--muted);font-size:13px}
  .actions{display:flex;gap:8px;margin-top:6px}
  .small{background:#2d3445}
  .danger{background:#ef4444}
</style>
</head>
<body>
  <header>
    <h1>사회자 질문 선택</h1>
    <div>
      <button class="btn small" id="refresh">새로고침</button>
      <button class="btn danger" id="clearAll">질문 전체삭제</button>
      <button class="btn small" id="stop">방송 중지</button>
    </div>
  </header>
  <main class="grid" id="list"></main>

<script>
const $list = document.getElementById('list');

async function load() {
  const r = await fetch('/api/questions').then(r=>r.json());
  const items = r.items || [];
  $list.innerHTML = items.map(i => card(i)).join('');
}

function card(i){
  return `
  <article class="card" data-id="${i.id}">
    <div class="txt">${escapeHtml(i.text)}</div>
    <div class="meta">${new Date(i.ts).toLocaleString()}</div>
    <div class="actions">
      <button class="btn" onclick="spotlight('${i.id}')">방송 표시</button>
      <button class="btn small" onclick="removeOne('${i.id}')">삭제</button>
    </div>
  </article>`;
}

function escapeHtml(s){
  return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

async function spotlight(id){
  await fetch('/api/questions/'+id+'/spotlight',{method:'POST'});
}

async function removeOne(id){
  // 프론트에서만 삭제하는게 아니라, 전체를 갈아끼우기 위해 필터 후 재삽입하는 대신 간단히 재등록 유도 (필요시 개별 삭제 API 추가 가능)
  const r = await fetch('/api/questions').then(r=>r.json());
  const left = (r.items||[]).filter(x=>x.id!==id).map(x=>x.text);
  await fetch('/api/questions',{method:'DELETE'});
  for(const t of left){
    await fetch('/api/questions',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:t})});
  }
  load();
}

document.getElementById('clearAll').onclick = async () => {
  if(!confirm('정말 모든 질문을 삭제할까요?')) return;
  await fetch('/api/questions',{method:'DELETE'});
  load();
};
document.getElementById('stop').onclick = async () => {
  await fetch('/api/spotlight',{method:'DELETE'});
  alert('방송을 중지했습니다.');
};
document.getElementById('refresh').onclick = load;

// 자동 새로고침(2초)
setInterval(load, 2000);
load();
</script>
</body>
</html>
